image: nixos/latest
sources:
  - https://git.sr.ht/~cyplo/blog

secrets:
  - 6c23a8c1-7a30-4a7e-b3b7-0171e898a7d3
  - 47d167ed-ef43-4515-9923-6954d34a4fab

oauth: pages.sr.ht/PAGES:RW

tasks:
  - hwinfo: |
      nix-shell -p lshw --run "lshw -short -quiet -sanitize -c memory -c processor"
  - fetch_tools: |
      cd blog
      nix-shell --pure --run 'date'
  - github_push: |
      set +xv
      cd blog
      GITHUB_TOKEN=`cat ~/.github_token`
      git remote add github https://cyplo:$GITHUB_TOKEN@github.com/cyplo/blog.git
      nix-shell --pure --run 'git push github --all --force'
  - build: |
      cd blog
      nix-shell --pure --run 'hugo --gc --minify'
  - package: |
      tar -C blog/public -cvz . > site.tar.gz
      ls -hal site.tar.gz
  - sourcehut_upload: |
      nix-shell blog/shell.nix --pure --run 'hut pages publish -d cyplo.srht.site site.tar.gz'
  - netlify_publish: |
      set +xv
      cd blog
      export NETLIFY_TOKEN=`cat ~/.netlify_token`
      nix-shell --pure --keep NETLIFY_TOKEN --run 'netlify-deployer master 7a0944f0-cfd0-424b-8252-ca44fc950350 public'
